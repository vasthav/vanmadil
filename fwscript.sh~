#!/bin/bash
whitelist=/usr/local/etc/whitelist.txt
blacklist=/usr/local/etc/blacklist.txt

allowed="22 25 53 80 443 465 587 993"
IPTABLES=/sbin/iptables
IPTABLES_SAVE=/sbin/iptables-save

$IPTABLES_SAVE > /usr/local/etc/iptables.last

$IPTABLES -P INPUT ACCEPT
echo 'setting default INPUT policy to ACCEPT'
$IPTABLES -F
echo 'clearing table F'
$IPTABLES -X
echo 'clearing table X'
$IPTABLES -Z
echo 'clearing table Z'
$IPTABLES -A INPUT -s 127.0.0.1 -j ACCEPT
echo 'allowing localhost'

echo "creating whitelist"
for x in `grep -v ^# $WHITELIST | awk '{print $1}'`; do
echo "Permitting $x..."
$IPTABLES -A INPUT -s $x -j ACCEPT
done

## permitting ports
echo "perimiting ports"
for port in $allowed; do
echo "accepting port tcp $port ... "
$IPTABLES -A INPUT -p tcp --dport $port -j ACCEPT
done

for port in $allowed; do
echo "accepting port UDP $port ... "
$IPTABLES -A INPUT -p udp --dport $dport -j ACCEPT
done

## allowing established and related connections only
$IPTABLES -A INPUT -m --state RELATED,ESTABLISHED -j ACCEPT

/etc/init.d/iptables save
